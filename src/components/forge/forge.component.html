<div class="h-full w-full bg-gray-800 p-4 flex flex-col animate-fadeIn">
  <header class="text-center mb-4">
    <h1 class="text-3xl font-orbitron text-orange-400">The Forge</h1>
    <p class="text-gray-400">Combine three items of the same type and rarity to forge a stronger one.</p>
  </header>

  <!-- Crafting Area -->
  <div class="bg-gray-900/50 p-4 md:p-6 rounded-lg mb-4">
    <div class="flex flex-col lg:flex-row items-center justify-center gap-6">

      <!-- Ingredients Section -->
      <div class="w-full lg:w-auto">
        <h3 class="text-lg font-orbitron text-gray-400 text-center mb-3">Materials</h3>
        <div class="bg-gray-800/50 p-4 rounded-lg flex items-center justify-center gap-2" [class.animate-forge-spark]="isForging()">
          @for (i of [0, 1, 2]; track i) {
            @let item = selectedItems()[i];
            <div class="w-24 h-36 flex-shrink-0 bg-gray-800 rounded-lg flex flex-col items-center justify-center border-2 p-1 text-center transition-all duration-300"
              [class]="item ? getRarityColor(item.rarity) : 'border-dashed border-gray-600'"
              [class.animate-forge-ingredient-use]="isForging()">
              @if(item) {
                <div class="flex flex-col justify-between h-full w-full">
                  <span class="font-bold text-sm leading-tight" [class]="getRarityTextColor(item.rarity)">{{ item.name }}</span>
                  <span class="text-xs text-gray-400 my-1">{{ item.slot }}</span>
                  <span class="text-xs text-green-400 bg-black/30 rounded px-1 py-0.5 w-full truncate">{{ formatBonus(item) }}</span>
                </div>
              } @else {
                <span class="text-gray-500 text-sm">Slot {{ i + 1 }}</span>
              }
            </div>
            @if (i < 2) {
              <span class="text-2xl font-bold text-gray-500 mx-1">+</span>
            }
          }
        </div>
      </div>

      <!-- Separator -->
      <div class="text-5xl font-bold text-orange-400 rotate-90 lg:rotate-0 flex-shrink-0 my-2 lg:my-0">
         <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
      </div>

      <!-- Result Section -->
      <div class="w-full lg:w-auto">
        <h3 class="text-lg font-orbitron text-gray-400 text-center mb-3">Result</h3>
        <div class="bg-gray-800/50 p-4 rounded-lg flex items-center justify-center">
          <div class="w-24 h-36 flex-shrink-0 bg-gray-800 rounded-lg flex items-center justify-center border-2 relative p-1"
               [class]="displayResult() ? getRarityColor(displayResult()!.rarity) : 'border-dashed border-gray-600'">
            @if(displayResult(); as result) {
              <div class="flex flex-col justify-between h-full w-full text-center p-1" [class.animate-item-pop-in]="showCraftAnimation()">
                <span class="font-bold text-lg leading-tight" [class]="getRarityTextColor(result.rarity)">{{ result.rarity }}</span>
                <span class="text-base text-gray-300 my-1">{{ result.slot }}</span>
                <span class="text-sm font-semibold" [class]="showCraftAnimation() ? 'text-orange-400' : 'text-gray-500'">{{ showCraftAnimation() ? 'Forged!' : '(Preview)' }}</span>
              </div>
            } @else if(!isForging()) {
              <span class="text-gray-500 text-sm">Result</span>
            }
          </div>
        </div>
      </div>
    </div>
    <button
        (click)="handleCraft()"
        [disabled]="!canCraft() || isForging()"
        class="w-full max-w-lg mx-auto mt-6 py-3 bg-orange-600 text-white font-bold rounded-md hover:bg-orange-700 transition-all duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed transform hover:scale-105 active:scale-100 disabled:hover:scale-100">
      {{ isForging() ? 'Forging...' : 'Forge Item' }}
    </button>
  </div>


  <!-- Inventory -->
  <div class="flex-grow overflow-y-auto pr-2 mt-2 border-t-2 border-gray-700 pt-4">
     <h2 class="text-2xl font-orbitron text-gray-300 mb-4 text-center">Your Materials</h2>
    @for(slot of ['Weapon', 'Armor', 'Accessory']; track slot) {
        <div class="mb-4">
            <h3 class="text-xl font-semibold text-gray-400 mb-2 border-b border-gray-700 pb-1">{{ slot }}s</h3>
            @if(inventoryBySlot()[slot].length > 0) {
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    @for(item of inventoryBySlot()[slot]; track item.id) {
                        <div 
                            (click)="toggleItemSelection(item.id)"
                            class="bg-gray-900 p-2 rounded-lg cursor-pointer border-2 transition-all duration-200 hover:bg-gray-700/70"
                            [class]="getRarityColor(item.rarity)"
                            [class.ring-4]="selectedItemIds().includes(item.id)"
                            [class.ring-yellow-300]="selectedItemIds().includes(item.id)"
                            [class.opacity-50]="(selectedItemIds().length === 3 && !selectedItemIds().includes(item.id)) || isForging()"
                            >
                            <p class="font-bold text-sm" [class]="getRarityTextColor(item.rarity)">{{ item.name }}</p>
                            <p class="text-xs text-green-400">{{ formatBonus(item) }}</p>
                        </div>
                    }
                </div>
            } @else {
                 <p class="text-gray-500 italic">No {{ slot.toLowerCase() }}s in inventory.</p>
            }
        </div>
    }
  </div>
</div>