<div class="h-screen w-screen bg-gray-900 text-gray-100 flex flex-col font-roboto">
  <!-- New Compact Header -->
  <header class="w-full bg-gray-900/80 backdrop-blur-sm z-30 flex-shrink-0 flex flex-col shadow-[0_5px_15px_-5px_rgba(168,85,247,0.4)]">
    <!-- Top Bar: Stage & Resources -->
    <div class="w-full max-w-screen-xl mx-auto flex justify-between items-center px-2 sm:px-4 py-1 border-b border-purple-600/30">
      <!-- Stage -->
      <div class="bg-gray-900/70 px-3 py-0.5 rounded-md border border-purple-500/30">
          <h1 class="text-xs sm:text-sm font-orbitron text-gray-300">Stage <span class="font-bold text-white">{{ gameService.gameState().stage }}</span></h1>
      </div>
      <!-- Resources -->
      <div class="flex items-center gap-2 sm:gap-4">
          <div class="px-2 py-0.5 rounded-lg min-w-[70px] sm:min-w-[90px] text-right">
              <span class="text-xs sm:text-sm font-bold shimmer-text-gold">ðŸ’° {{ formatNumber(gameService.gameState().gold) }}</span>
          </div>
          <div class="px-2 py-0.5 rounded-lg min-w-[50px] sm:min-w-[70px] text-right">
              <span class="text-xs sm:text-sm font-bold text-cyan-300">ðŸ’Ž {{ formatNumber(gameService.gameState().prestigePoints) }}</span>
          </div>
          <div class="px-2 py-0.5 rounded-lg min-w-[50px] sm:min-w-[70px] text-right" [appTooltip]="'Enchanting Dust'">
              <span class="text-xs sm:text-sm font-bold shimmer-text-purple">ðŸ’§ {{ formatNumber(gameService.gameState().enchantingDust) }}</span>
          </div>
      </div>
    </div>
    
    <!-- Bottom Bar: Navigation -->
    <div class="w-full max-w-screen-xl mx-auto flex justify-center items-center px-2 py-0.5 gap-2 sm:gap-4">
        <button (click)="changeView('combat')" class="relative flex items-center justify-center p-1.5 rounded-lg transition-colors duration-200 active:scale-95 text-gray-300" [appTooltip]="'Battle'" [class.bg-red-500/20]="activeView() === 'combat'" [class.text-red-300]="activeView() === 'combat'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
        </button>
        <button (click)="changeView('teamHub')" class="relative flex items-center justify-center p-1.5 rounded-lg transition-colors duration-200 active:scale-95 text-gray-300" [appTooltip]="'Manage Team'" [class.bg-purple-500/20]="activeView() === 'team' || activeView() === 'teamHub' || activeView() === 'heroDetail'" [class.text-purple-300]="activeView() === 'team' || activeView() === 'teamHub' || activeView() === 'heroDetail'">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.122-1.28-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.122-1.28.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
        </button>
        <button (click)="changeView('summon')" class="relative flex items-center justify-center p-1.5 rounded-lg transition-colors duration-200 active:scale-95 text-gray-300" [appTooltip]="'Summon Heroes'" [class.bg-cyan-500/20]="activeView() === 'summon'" [class.text-cyan-300]="activeView() === 'summon'">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 22 12 18.27 18.18 22l-1.64-7.03L22 9.24l-7.19-.61L12 2z" /></svg>
        </button>
        
        <div class="w-px h-6 bg-gray-700 mx-1"></div>

        <button (click)="changeView('upgrades')" class="relative flex items-center justify-center p-1.5 rounded-lg transition-colors duration-200 active:scale-95 text-gray-300" [appTooltip]="'Upgrades'" [class.bg-green-500/20]="activeView() === 'upgrades'" [class.text-green-300]="activeView() === 'upgrades'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
        </button>
        <button (click)="changeView('quests')" class="relative flex items-center justify-center p-1.5 rounded-lg transition-colors duration-200 active:scale-95 text-gray-300" [appTooltip]="'Quests'" [class.bg-yellow-500/20]="activeView() === 'quests'" [class.text-yellow-300]="activeView() === 'quests'">
           @if (gameService.hasClaimableQuests()) {
            <span class="absolute top-0.5 right-0.5 w-2.5 h-2.5 bg-green-400 rounded-full border-2 border-gray-900 animate-pulse"></span>
          }
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5V3a2 2 0 012-2h2a2 2 0 012 2v2m-6 9l2 2 4-4" /></svg>
        </button>

        <div class="w-px h-6 bg-gray-700 mx-1"></div>
        
        <div class="relative">
          <button id="menu-button" (click)="toggleMenu()" class="relative flex items-center justify-center p-1.5 rounded-lg transition-colors duration-200 active:scale-95 text-gray-300" [appTooltip]="'More Options'" [class.bg-purple-500/20]="isMenuOpen()" [class.text-purple-300]="isMenuOpen()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
          </button>

          @if(isMenuOpen()) {
            <div id="menu-dropdown" class="absolute right-0 mt-2 w-96 origin-top-right bg-gray-800 border-2 border-purple-500/50 rounded-lg shadow-lg z-50 animate-pop-in-soft" style="animation-duration: 0.15s;">
                <div class="p-2">
                    <!-- Primary Hubs -->
                    <div class="mb-2">
                        <h3 class="px-2 pt-1 pb-2 text-xs font-bold text-gray-500 uppercase tracking-wider">Primary Hubs</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button (click)="changeView('base')" class="flex flex-col items-center justify-center gap-2 p-3 text-sm text-gray-300 rounded-md hover:bg-white/10 transition-colors w-full cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM4 12a2 2 0 012-2h12a2 2 0 012 2v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5z" /></svg>
                                <span class="font-semibold">Base Command</span>
                            </button>
                             <button (click)="changeView('heroCommand')" class="flex flex-col items-center justify-center gap-2 p-3 text-sm text-gray-300 rounded-md hover:bg-white/10 transition-colors w-full cursor-pointer">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                <span class="font-semibold">Hero Command</span>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-x-2">
                        <!-- Operations & Powers -->
                        <div>
                            <h3 class="px-2 pt-1 pb-2 text-xs font-bold text-gray-500 uppercase tracking-wider">Operations & Powers</h3>
                            <div class="space-y-1">
                                <button (click)="changeView('upgrades')" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 rounded-md hover:bg-white/10 transition-colors w-full cursor-pointer">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 11l3-3m0 0l3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z" /></svg>
                                    <span>Prestige & Upgrades</span>
                                </button>
                                <button (click)="changeView('celestialShrine')" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 rounded-md hover:bg-white/10 transition-colors w-full cursor-pointer">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
                                    <span>Celestial Shrine</span>
                                </button>
                                <button (click)="changeView('tower')" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 rounded-md hover:bg-white/10 transition-colors w-full cursor-pointer">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v1h1a1 1 0 010 2H5v1h1a1 1 0 010 2H5v1h1a1 1 0 010 2H5v1h1a1 1 0 110 2H5v1a1 1 0 01-2 0V3a1 1 0 011-1zm11 0a1 1 0 011 1v1h1a1 1 0 110 2h-1v1h1a1 1 0 110 2h-1v1h1a1 1 0 110 2h-1v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0V3a1 1 0 011-1zM8 2a1 1 0 011 1v1h1a1 1 0 110 2H9v1h1a1 1 0 110 2H9v1h1a1 1 0 110 2H9v1h1a1 1 0 110 2H9v1a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                    <span>Tower of Trials</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Resources & Info -->
                        <div>
                            <h3 class="px-2 pt-1 pb-2 text-xs font-bold text-gray-500 uppercase tracking-wider">Resources & Info</h3>
                            <div class="space-y-1">
                                <button (click)="changeView('inventory')" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 rounded-md hover:bg-white/10 transition-colors w-full cursor-pointer">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                                    <span>Inventory</span>
                                </button>
                                 <button (click)="changeView('artifacts')" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 rounded-md hover:bg-white/10 transition-colors w-full cursor-pointer">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                    <span>Artifacts</span>
                                 </button>
                                <button (click)="changeView('leaderboard')" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 rounded-md hover:bg-white/10 transition-colors w-full cursor-pointer">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 10-2 0v1.586l-1.293-1.293a1 1 0 10-1.414 1.414L7.586 6H6a1 1 0 000 2h1.586l-1.293 1.293a1 1 0 101.414 1.414L9 8.414V10a1 1 0 102 0V8.414l1.293 1.293a1 1 0 101.414-1.414L12.414 7H14a1 1 0 100-2h-1.586l1.293-1.293a1 1 0 00-1.414-1.414L11 4.586V3z" /><path d="M3 13a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                                    <span>Leaderboard</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Game Group -->
                    <div class="border-t border-gray-700/50 mt-2 pt-2">
                        <button (click)="changeView('settings')" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 rounded-md hover:bg-white/10 transition-colors w-full cursor-pointer">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                            <span>Settings & Stats</span>
                        </button>
                    </div>
                </div>
            </div>
          }
        </div>
    </div>
  </header>

  <!-- Main Content Area -->
  <main class="flex-grow overflow-hidden relative">
    @switch (activeView()) {
      @case ('combat') { <app-combat [gameService]="gameService"></app-combat> }
      @case ('team') { <app-team (viewChange)="changeView($event)" [gameService]="gameService"></app-team> }
      @case ('inventory') { <app-inventory [gameService]="gameService"></app-inventory> }
      @case ('summon') { <app-summon (heroUnlocked)="handleNewHeroUnlock($event)" [gameService]="gameService"></app-summon> }
      @case ('upgrades') { <app-upgrades [gameService]="gameService"></app-upgrades> }
      @case ('quests') { <app-quests [gameService]="gameService"></app-quests> }
      @case ('forge') { <app-forge [gameService]="gameService"></app-forge> }
      @case ('tower') { <app-tower [gameService]="gameService"></app-tower> }
      @case ('expeditions') { <app-expeditions [gameService]="gameService"></app-expeditions> }
      @case ('celestialShrine') { <app-celestial-shrine [gameService]="gameService"></app-celestial-shrine> }
      @case ('alchemyLab') { <app-alchemy-lab (viewChange)="changeView($event)" [gameService]="gameService"></app-alchemy-lab> }
      @case ('enchant') { <app-enchant (viewChange)="changeView($event)" [gameService]="gameService"></app-enchant> }
      @case ('settings') { <app-settings [gameService]="gameService"></app-settings> }
      @case ('codex') { <app-codex [gameService]="gameService"></app-codex> }
      @case ('artifacts') { <app-artifacts [gameService]="gameService"></app-artifacts> }
      @case ('synergies') { <app-synergies [gameService]="gameService"></app-synergies> }
      @case ('fusion') { <app-fusion [gameService]="gameService"></app-fusion> }
      @case ('heroUnlock') {
        @if(heroToUnlockId(); as id) {
            <app-hero-unlock (viewChange)="changeView($event)" [gameService]="gameService" [heroId]="id"></app-hero-unlock>
        } @else {
            <!-- Fallback if no hero ID is set -->
            <app-team (viewChange)="changeView($event)" [gameService]="gameService"></app-team>
        }
      }
      @case ('heroDetail') { <app-hero-detail (viewChange)="changeView($event)" [gameService]="gameService"></app-hero-detail> }
      @case ('base') { <app-base (viewChange)="changeView($event)" [gameService]="gameService"></app-base> }
      @case ('teamHub') { <app-team-hub (viewChange)="changeView($event)" [gameService]="gameService"></app-team-hub> }
      @case ('reliques') { <app-reliques (viewChange)="changeView($event)" [gameService]="gameService"></app-reliques> }
      @case ('dungeons') { <app-dungeons (viewChange)="changeView($event)" [gameService]="gameService"></app-dungeons> }
      @case ('leaderboard') { <app-leaderboard (viewChange)="changeView($event)" [gameService]="gameService"></app-leaderboard> }
      @case ('pets') { <app-pets (viewChange)="changeView($event)" [gameService]="gameService"></app-pets> }
      @case ('heroCommand') { <app-hero-command (viewChange)="changeView($event)"></app-hero-command> }
    }
  </main>

  <!-- Offline Progress Modal -->
  @if(showOfflineReport() && gameService.offlineReport(); as report) {
    <div class="absolute inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm border-2 border-purple-500 animate-pop-in-soft p-6 text-center">
            <h2 class="text-2xl font-orbitron text-purple-400 mb-2">Welcome Back!</h2>
            <p class="text-gray-300 mb-4">Your heroes fought while you were away for {{ (report.seconds / 60).toFixed(0) }} minutes.</p>
            <div class="bg-gray-900/50 rounded-lg p-4 space-y-2 text-left">
                <p class="text-lg"><span class="font-semibold text-yellow-300">Gold Earned:</span> ðŸ’° {{ formatNumber(report.gold) }}</p>
                <p class="text-lg"><span class="font-semibold text-blue-300">Total XP Gained:</span> âœ¨ {{ formatNumber(report.xp) }}</p>
            </div>
            <p class="text-xs text-gray-500 mt-2">(Offline XP has been added to your active heroes)</p>
            <button (click)="claimOfflineReport()" class="mt-6 w-full py-2 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 transition-colors">
              Awesome!
            </button>
        </div>
    </div>
  }

  <!-- Daily Login Modal -->
  @if(showDailyLogin() && dailyReward(); as reward) {
     <div class="absolute inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-sm border-2 border-green-500 animate-pop-in-soft p-6 text-center">
            <h2 class="text-2xl font-orbitron text-green-400 mb-2">Daily Login Reward</h2>
            <p class="text-gray-300 mb-4">Day <span class="font-bold text-white">{{ gameService.gameState().consecutiveLoginDays }}</span> of 7 consecutive logins.</p>
            <div class="bg-gray-900/50 rounded-lg p-4 space-y-2">
                <p class="text-2xl font-bold text-yellow-200">Today's Reward:</p>
                @if (reward.gold > 0) {
                  <p class="text-xl">ðŸ’° {{ formatNumber(reward.gold) }} Gold</p>
                }
                @if (reward.prestigePoints > 0) {
                  <p class="text-xl">ðŸ’Ž {{ formatNumber(reward.prestigePoints) }}</p>
                }
            </div>
            <button (click)="claimDailyReward()" class="mt-6 w-full py-2 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 transition-colors">
              Claim
            </button>
        </div>
    </div>
  }
</div>
